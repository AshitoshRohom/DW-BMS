<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- ============================================================
         Report Action
    ============================================================ -->
    <record id="action_report_invoice_custom" model="ir.actions.report">
        <field name="name">Tax Invoice</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">DW_BMS.report_invoice_custom_template</field>
        <field name="report_file">DW_BMS.report_invoice_custom_template</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="print_report_name">'Invoice - %s' % (object.name)</field>
    </record>

    <!-- ============================================================
         QWeb Template
    ============================================================ -->
    <template id="report_invoice_custom_template">
        <t t-call="web.html_container">
            <meta charset="utf-8"/>
            <t t-foreach="docs" t-as="doc">
                <!-- Only render for customer invoices -->
                <t t-if="doc.move_type == 'out_invoice'">
                <div class="page">
                <style>
                    /* ---- Page wrapper ---- */
                    .inv-wrap {
                        border: 1.5px solid #8fa0bf;
                        width: 100%;
                        min-height: 1050px;
                        box-sizing: border-box;
                        font-size: 12.5px;
                        line-height: 1.4;
                        color: #111;
                        font-family: "DejaVu Sans", Arial, sans-serif;
                    }

                    /* ---- HEADER ---- */
                    .inv-header-table {
                        width: 100%;
                        border-collapse: collapse;
                        border-spacing: 0;
                    }
                    .inv-header-table td {
                        border-bottom: 1.5px solid #8fa0bf;
                        padding: 14px 16px;
                        vertical-align: middle;
                    }
                    .inv-logo-cell {
                        width: 30%;
                        text-align: center;
                    }
                    .inv-logo {
                        max-height: 90px;
                        max-width: 160px;
                    }
                    .inv-company-cell {
                        width: 70%;
                        text-align: right;
                    }
                    .inv-company-name {
                        font-size: 22px;
                        font-weight: 700;
                        color: #4f648b;
                        margin: 0 0 4px 0;
                        line-height: 1.2;
                    }
                    .inv-company-detail {
                        font-size: 11.5px;
                        color: #333;
                        margin: 2px 0;
                        line-height: 1.5;
                    }
                    .inv-gst-text {
                        margin-top: 5px;
                        font-size: 11.5px;
                        color: #333;
                        font-weight: 700;
                    }

                    /* ---- TITLE BANNER ---- */
                    .inv-title {
                        text-align: center;
                        font-size: 17px;
                        font-weight: 700;
                        letter-spacing: 2px;
                        text-transform: uppercase;
                        background: #9aaacc;
                        color: #fff;
                        padding: 7px 0;
                        margin: 0;
                    }

                    /* ---- GENERAL TABLE ---- */
                    .inv-table {
                        width: 100%;
                        border-collapse: collapse;
                        border-spacing: 0;
                        table-layout: fixed;
                    }
                    .inv-table td,
                    .inv-table th {
                        border: 1px solid #b0bcd4;
                        padding: 6px 8px;
                        vertical-align: top;
                    }
                    .inv-label {
                        font-weight: 700;
                        color: #4f648b;
                        white-space: nowrap;
                    }

                    /* ---- ADDRESS SECTION ---- */
                    .inv-addr-section {
                        width: 100%;
                        border-collapse: collapse;
                        border-spacing: 0;
                    }
                    .inv-addr-section td {
                        border: 1px solid #b0bcd4;
                        padding: 8px 10px;
                        vertical-align: top;
                        width: 50%;
                    }
                    .inv-addr-heading {
                        font-size: 10px;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        color: #4f648b;
                        border-bottom: 1px solid #b0bcd4;
                        padding-bottom: 4px;
                        margin-bottom: 5px;
                    }
                    .inv-addr-name {
                        font-weight: 700;
                        font-size: 13px;
                        margin-bottom: 3px;
                    }
                    .inv-addr-text {
                        font-size: 11.5px;
                        line-height: 1.6;
                        color: #222;
                    }

                    /* ---- META TABLE ---- */
                    .inv-meta td:first-child {
                        width: 28%;
                    }

                    /* ---- PAYMENT PAID BADGE ---- */
                    .inv-paid-row td {
                        border: 1px solid #b0bcd4;
                        padding: 6px 10px;
                        background: #f3f7fc;
                    }
                    .inv-paid-stamp {
                        display: inline-block;
                        border: 2px solid #2e7d32;
                        color: #2e7d32;
                        border-radius: 4px;
                        padding: 2px 12px;
                        font-size: 13px;
                        font-weight: 700;
                        letter-spacing: 1.5px;
                        text-transform: uppercase;
                        margin-right: 10px;
                    }
                    .inv-paid-bank {
                        font-size: 11.5px;
                        color: #333;
                    }

                    /* ---- PRODUCT TABLE ---- */
                    .inv-lines thead th {
                        background: #9aaacc;
                        color: #fff;
                        font-weight: 700;
                        text-align: center;
                        padding: 7px 6px;
                        border: 1px solid #9aaacc;
                    }
                    .inv-lines tbody td {
                        border: 1px solid #b0bcd4;
                        padding: 6px 7px;
                        vertical-align: middle;
                    }
                    .inv-lines tbody tr:nth-child(even) td {
                        background: #f8faff;
                    }
                    .inv-right  { text-align: right; }
                    .inv-center { text-align: center; }

                    /* ---- TOTALS ---- */
                    .inv-totals {
                        width: 44%;
                        margin-left: auto;
                        border-collapse: collapse;
                        border-spacing: 0;
                        margin-top: 0;
                    }
                    .inv-totals td {
                        border: 1px solid #b0bcd4;
                        padding: 6px 10px;
                    }
                    .inv-totals tr:last-child td {
                        background: #8ea3c8;
                        color: #fff;
                        font-weight: 700;
                        font-size: 13px;
                    }
                    .inv-section-gap {
                        height: 0;
                        border: none;
                    }
                </style>

                <div class="inv-wrap">

                    <!-- ========== 1. COMPANY HEADER ========== -->
                    <table class="inv-header-table">
                        <tr>
                            <td class="inv-logo-cell">
                                <img t-if="doc.company_id.logo"
                                     t-att-src="image_data_uri(doc.company_id.logo)"
                                     alt="Logo"
                                     class="inv-logo"/>
                            </td>
                            <td class="inv-company-cell">
                                <p class="inv-company-name">
                                    <span t-field="doc.company_id.name"/>
                                </p>
                                <p class="inv-company-detail">
                                    <span t-if="doc.company_id.street"
                                          t-esc="doc.company_id.street"/><t
                                        t-if="doc.company_id.street2">,
                                        <span t-esc="doc.company_id.street2"/>
                                    </t>
                                </p>
                                <p class="inv-company-detail">
                                    <t t-if="doc.company_id.city">
                                        <span t-esc="doc.company_id.city"/>
                                    </t>
                                    <t t-if="doc.company_id.state_id">
                                        , <span t-esc="doc.company_id.state_id.name"/>
                                    </t>
                                    <t t-if="doc.company_id.zip">
                                        - <span t-esc="doc.company_id.zip"/>
                                    </t>
                                    <t t-if="doc.company_id.country_id">
                                        , <span t-esc="doc.company_id.country_id.name"/>
                                    </t>
                                </p>
                                <p class="inv-company-detail">
                                    <t t-if="doc.company_id.phone">
                                        <strong>Ph:</strong>
                                        <span t-esc="doc.company_id.phone"/>
                                    </t>
                                    <t t-if="doc.company_id.email">
                                        &amp;nbsp;|&amp;nbsp;
                                        <strong>Email:</strong>
                                        <span t-esc="doc.company_id.email"/>
                                    </t>
                                </p>
                                <t t-if="doc.company_id.partner_id.vat">
                                    <p class="inv-gst-text">
                                        GSTIN: <span t-esc="doc.company_id.partner_id.vat"/>
                                    </p>
                                </t>
                            </td>
                        </tr>
                    </table>

                    <!-- ========== 2. TITLE BANNER ========== -->
                    <h2 class="inv-title">Tax Invoice</h2>

                    <!-- ========== 3. CUSTOMER + BILL TO / SHIP TO ========== -->
                    <table class="inv-addr-section">
                        <tr>
                            <!-- Customer Info -->
                            <td style="width:33%; border-right: 1px solid #b0bcd4;">
                                <div class="inv-addr-heading">Customer Details</div>
                                <div class="inv-addr-name">
                                    <span t-field="doc.partner_id.name"/>
                                </div>
                                <div class="inv-addr-text">
                                    <t t-if="doc.partner_id.phone">
                                        <strong>Ph:</strong>
                                        <span t-esc="doc.partner_id.phone"/>
                                        <br/>
                                    </t>
                                    <t t-if="doc.partner_id.email">
                                        <strong>Email:</strong>
                                        <span t-esc="doc.partner_id.email"/>
                                        <br/>
                                    </t>
                                    <t t-if="doc.partner_id.vat">
                                        <strong>GSTIN:</strong>
                                        <span t-esc="doc.partner_id.vat"/>
                                    </t>
                                </div>
                            </td>

                            <!-- Bill To -->
                            <td style="width:33%; border-right: 1px solid #b0bcd4;">
                                <div class="inv-addr-heading">Bill To</div>
                                <div class="inv-addr-name">
                                    <span t-field="doc.partner_id.name"/>
                                </div>
                                <div class="inv-addr-text">
                                    <t t-if="doc.bill_to_same_as_customer">
                                        <!-- Use partner address when same as customer -->
                                        <span t-esc="doc.partner_id.street or ''"/>
                                        <t t-if="doc.partner_id.street2">
                                            , <span t-esc="doc.partner_id.street2"/>
                                        </t>
                                        <t t-if="doc.partner_id.city">
                                            <br/><span t-esc="doc.partner_id.city"/>
                                        </t>
                                        <t t-if="doc.partner_id.state_id">
                                            , <span t-esc="doc.partner_id.state_id.name"/>
                                        </t>
                                        <t t-if="doc.partner_id.zip">
                                            - <span t-esc="doc.partner_id.zip"/>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <!-- Custom bill-to address -->
                                        <t t-if="doc.bill_to_address">
                                            <span t-esc="doc.bill_to_address"/>
                                        </t>
                                        <t t-if="doc.bill_to_city">
                                            <br/><span t-esc="doc.bill_to_city"/>
                                        </t>
                                        <t t-if="doc.bill_to_state_id">
                                            , <span t-esc="doc.bill_to_state_id.name"/>
                                        </t>
                                        <t t-if="doc.bill_to_zip">
                                            - <span t-esc="doc.bill_to_zip"/>
                                        </t>
                                    </t>
                                </div>
                            </td>

                            <!-- Ship To -->
                            <td style="width:34%;">
                                <div class="inv-addr-heading">Ship To</div>
                                <div class="inv-addr-name">
                                    <span t-field="doc.partner_id.name"/>
                                </div>
                                <div class="inv-addr-text">
                                    <t t-if="doc.ship_to_same_as_customer">
                                        <!-- Use partner address when same as customer -->
                                        <span t-esc="doc.partner_id.street or ''"/>
                                        <t t-if="doc.partner_id.street2">
                                            , <span t-esc="doc.partner_id.street2"/>
                                        </t>
                                        <t t-if="doc.partner_id.city">
                                            <br/><span t-esc="doc.partner_id.city"/>
                                        </t>
                                        <t t-if="doc.partner_id.state_id">
                                            , <span t-esc="doc.partner_id.state_id.name"/>
                                        </t>
                                        <t t-if="doc.partner_id.zip">
                                            - <span t-esc="doc.partner_id.zip"/>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <!-- Custom ship-to address -->
                                        <t t-if="doc.ship_to_address">
                                            <span t-esc="doc.ship_to_address"/>
                                        </t>
                                        <t t-if="doc.ship_to_city">
                                            <br/><span t-esc="doc.ship_to_city"/>
                                        </t>
                                        <t t-if="doc.ship_to_state_id">
                                            , <span t-esc="doc.ship_to_state_id.name"/>
                                        </t>
                                        <t t-if="doc.ship_to_zip">
                                            - <span t-esc="doc.ship_to_zip"/>
                                        </t>
                                    </t>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <!-- ========== 4. INVOICE META ========== -->
                    <table class="inv-table inv-meta" style="margin-top:0;">
                        <tr>
                            <td class="inv-label" style="width:25%;">Invoice Number</td>
                            <td style="width:25%;">
                                <span t-field="doc.name"/>
                            </td>
                            <td class="inv-label" style="width:25%;">Invoice Date</td>
                            <td style="width:25%;" class="inv-center">
                                <span t-field="doc.invoice_date"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="inv-label">Payment Reference</td>
                            <td>
                                <span t-field="doc.payment_reference"/>
                            </td>
                            <td class="inv-label">Payment Terms</td>
                            <td class="inv-center">
                                <span t-field="doc.invoice_payment_term_id"/>
                            </td>
                        </tr>
                    </table>

                    <!-- ========== 5. PAYMENT DETAILS ========== -->
                    <t t-set="payment_items" t-value="doc.invoice_payments_widget and doc.invoice_payments_widget.get('content', []) or []"/>
                    <table class="inv-table" style="margin-top:0;">
                        <tr class="inv-paid-row">
                            <td class="inv-label" style="width:25%;">Payment Status</td>
                            <td style="width:75%;">
                                <t t-if="doc.payment_state == 'paid'">
                                    Paid
                                </t>
                                <t t-else="">
                                    Unpaid
                                </t>
                            </td>
                        </tr>
                        <t t-if="doc.payment_state == 'paid' and payment_items">
                            <tr>
                                <td class="inv-label">Bank / Account</td>
                                <td>
                                    
                                        <t t-foreach="payment_items" t-as="pmt">
                                            <span t-esc="pmt.get('journal_name') or pmt.get('payment_name') or pmt.get('move_name') or ''"/>
                                            <t t-if="not pmt_last">, </t>
                                        </t>
                                    
                                </td>
                            </tr>
                        </t>
                    </table>

                    <!-- ========== 6. PRODUCT LINES ========== -->
                    <!-- Determine GST type once -->
                    <t t-set="is_same_state"
                       t-value="doc.partner_id.state_id and doc.company_id.state_id and doc.partner_id.state_id == doc.company_id.state_id"/>

                    <table class="inv-table inv-lines" style="margin-top:0;">
                        <thead>
                            <tr>
                                <th style="width:5%;">S.No</th>
                                <th style="width:28%;">Product</th>
                                <th style="width:12%;">HSN Code</th>
                                <th style="width:9%;">Qty</th>
                                <th style="width:9%;">UOM</th>
                                <th style="width:18%;">Unit Price</th>
                                <th style="width:19%;">Total Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="invoice_lines"
                               t-value="doc.invoice_line_ids.filtered(lambda l: l.display_type == 'product' or not l.display_type)"/>
                            <t t-if="not invoice_lines">
                                <t t-set="invoice_lines"
                                   t-value="doc.line_ids.filtered(lambda l: (l.display_type == 'product' or not l.display_type) and not l.exclude_from_invoice_tab)"/>
                            </t>
                            <t t-set="line_no" t-value="0"/>
                            <t t-foreach="invoice_lines" t-as="line">
                                <t t-set="line_no" t-value="line_no + 1"/>
                                <tr>
                                    <td class="inv-center">
                                        <span t-esc="line_no"/>
                                    </td>
                                    <td>
                                        <span t-esc="line.product_id.display_name or line.name or '-'"/>
                                        <t t-if="line.name and line.product_id and line.name != line.product_id.display_name">
                                            <br/><small style="color:#555;"><span t-esc="line.name"/></small>
                                        </t>
                                    </td>
                                    <td class="inv-center">
                                        <span t-esc="line.hsn_code or (line.product_id and line.product_id.l10n_in_hsn_code) or ''"/>
                                    </td>
                                    <td class="inv-right">
                                        <span t-field="line.quantity"/>
                                    </td>
                                    <td class="inv-center">
                                        <span t-field="line.product_uom_id"/>
                                    </td>
                                    <td class="inv-right">
                                        <span t-esc="line.price_unit"
                                              t-options='{"widget":"monetary","display_currency": doc.currency_id}'/>
                                    </td>
                                    <td class="inv-right">
                                        <span t-esc="line.price_subtotal"
                                              t-options='{"widget":"monetary","display_currency": doc.currency_id}'/>
                                    </td>
                                </tr>
                            </t>
                            <tr t-if="not invoice_lines">
                                <td colspan="7" class="inv-center" style="color:#666;">No product lines found for this invoice.</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- ========== 7. TOTALS ========== -->
                    <table class="inv-totals">
                        <tr>
                            <td><strong>Untaxed Amount</strong></td>
                            <td class="inv-right">
                                <span t-esc="doc.amount_untaxed"
                                      t-options='{"widget":"monetary","display_currency": doc.currency_id}'/>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <strong>
                                    Tax Amount
                                    (<t t-if="is_same_state">GST</t><t t-else="">IGST</t>)
                                </strong>
                            </td>
                            <td class="inv-right">
                                <span t-esc="doc.amount_tax"
                                      t-options='{"widget":"monetary","display_currency": doc.currency_id}'/>
                            </td>
                        </tr>
                        <tr>
                            <td>Total (Incl. Tax)</td>
                            <td class="inv-right">
                                <span t-esc="doc.amount_total"
                                      t-options='{"widget":"monetary","display_currency": doc.currency_id}'/>
                            </td>
                        </tr>
                    </table>

                </div><!-- end inv-wrap -->
                </div><!-- end page -->
                </t>
            </t>
        </t>
    </template>
</odoo>
